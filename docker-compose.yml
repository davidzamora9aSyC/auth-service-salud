services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: meusalud_auth
      POSTGRES_USER: meusalud_auth
      POSTGRES_PASSWORD: meusalud_auth
    ports:
      - "5435:5432"
    volumes:
      - meusalud-auth-db:/var/lib/postgresql/data

  auth-service:
    build: .
    env_file:
      - .env
      - .env.local
    ports:
      - "3000:3000"
    volumes:
      - ./secrets:/keys:ro
    depends_on:
      - db
      - communication-service

  communication-service:
    build:
      context: ../communication-service
    env_file:
      - ../communication-service/.env.compose
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=notification
    ports:
      - "3006:3006"
    depends_on:
      - db

  users-service:
    build:
      context: ../users-service
    env_file:
      - ../users-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=users
      RABBITMQ_URL: amqp://app:app_pass_123@host.docker.internal:5673/
      RABBITMQ_EXCHANGE_IMAGES: images.events
      RABBITMQ_QUEUE_IMAGES: users.q.images
    ports:
      - "3008:3008"
    depends_on:
      - db

  doctors-service:
    build:
      context: ../doctors-service
    env_file:
      - ../doctors-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=doctors
      RABBITMQ_URL: amqp://app:app_pass_123@host.docker.internal:5673/
      RABBITMQ_EXCHANGE_IMAGES: images.events
      RABBITMQ_QUEUE_IMAGES: doctors.q.images
    ports:
      - "3009:3009"
    depends_on:
      - db

  appointments-service:
    build:
      context: ../appointments-service
    env_file:
      - ../appointments-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=appointments
      RABBITMQ_URL: amqp://app:app_pass_123@host.docker.internal:5673/
      SERVICES_SERVICE_URL: http://services-service:3011/servicesms
      AVAILABILITY_SERVICE_URL: http://availability-service:3012/availabilityms
    ports:
      - "3010:3010"
    depends_on:
      - db

  services-service:
    build:
      context: ../services-service
    env_file:
      - ../services-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=services
      RABBITMQ_URL: amqp://app:app_pass_123@host.docker.internal:5673/
    ports:
      - "3011:3011"
    depends_on:
      - db

  availability-service:
    build:
      context: ../availability-service
    env_file:
      - ../availability-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=availability
      SERVICES_BASE_URL: http://services-service:3011/servicesms
      APPOINTMENTS_BASE_URL: http://appointments-service:3010/appointmentsms
    ports:
      - "3012:3012"
    depends_on:
      - db

  meili:
    image: getmeili/meilisearch:v1.10
    restart: unless-stopped
    environment:
      MEILI_NO_ANALYTICS: "true"
    ports:
      - "7700:7700"
    volumes:
      - meili_data:/meili_data

  meusaludgateway:
    build:
      context: ../meusaludgateway
    env_file:
      - ../meusaludgateway/.env
    ports:
      - "3020:3020"
    depends_on:
      - auth-service
      - users-service
      - doctors-service
      - appointments-service
      - services-service
      - availability-service
      - communication-service
      - consents-service
      - analytics-service
      - images-service

  search-service:
    build:
      context: ../search-service
    env_file:
      - ../search-service/.env
    ports:
      - "3017:3017"
    depends_on:
      - meili

  subscriptions-service:
    build:
      context: ../subscriptions-service
    env_file:
      - ../subscriptions-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=subscriptions
      RABBITMQ_URL: amqp://app:app_pass_123@host.docker.internal:5673/
      RABBITMQ_EXCHANGE_PAYMENTS: payments.events
      RABBITMQ_EXCHANGE_SUBSCRIPTIONS: subscriptions.events
      RABBITMQ_QUEUE_PAYMENTS: subs.q.payments
      SUBSCRIPTIONS_INTERNAL_API_KEY: ""
    ports:
      - "3013:3013"
    depends_on:
      - db

  payments-service:
    build:
      context: ../payments-service
    env_file:
      - ../payments-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=payments
      RABBITMQ_URL: amqp://app:app_pass_123@host.docker.internal:5673/
      RABBITMQ_EXCHANGE_PAYMENTS: payments.events
      SUBSCRIPTIONS_BASE_URL: http://subscriptions-service:3013/subscriptionsms
      WOMPI_ENV: sandbox
    ports:
      - "3014:3014"
    depends_on:
      - db

  analytics-service:
    build:
      context: ../analytics-service
    env_file:
      - ../analytics-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=analytics
      RABBITMQ_URL: amqp://app:app_pass_123@host.docker.internal:5673/
      RABBITMQ_EXCHANGE_APPOINTMENTS: appointments.events
      RABBITMQ_EXCHANGE_SERVICES: services.events
      RABBITMQ_EXCHANGE_DOCTORS: doctors.events
      RABBITMQ_QUEUE_ANALYTICS: analytics.q.events
    ports:
      - "3015:3015"
    depends_on:
      - db

  images-service:
    build:
      context: ../images-service
    env_file:
      - ../images-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=images
      S3_BUCKET_PRIVATE: images-private
      S3_REGION: us-east-1
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: minio
      S3_SECRET_KEY: minio12345
      S3_FORCE_PATH_STYLE: "true"
      RABBITMQ_URL: amqp://app:app_pass_123@host.docker.internal:5673/
      RABBITMQ_EXCHANGE_IMAGES: images.events
    ports:
      - "3019:3019"
    depends_on:
      - db
      - minio

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio12345
    volumes:
      - minio_data:/data

  consents-service:
    build:
      context: ../consents-service
    env_file:
      - ../consents-service/.env
    environment:
      DATABASE_URL: postgresql://meusalud_auth:meusalud_auth@db:5432/meusalud_auth?schema=consents
      RABBITMQ_URL: amqp://app:app_pass_123@host.docker.internal:5673/
      RABBITMQ_EXCHANGE_CONSENTS: consents.events
    ports:
      - "3018:3018"
    depends_on:
      - db

volumes:
  meusalud-auth-db:
  meili_data:
  minio_data:
